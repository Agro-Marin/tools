{
  "version": "4.0",
  "description": "Comprehensive Odoo database migration configuration with phase-based execution, CASCADE constraint management, and idempotent operations",
  "metadata": {
    "created": "2025-10-09",
    "model_count": 31,
    "total_operations": 247,
    "estimated_duration_minutes": 45,
    "database_compatibility": "PostgreSQL 12+",
    "odoo_version": "16.0"
  },
  "phases": {
    "fk_rewrite": {
      "order": 1,
      "description": "Rewrite foreign key constraints to CASCADE for safe ID compaction",
      "parallel": false,
      "critical": true
    },
    "cleanup": {
      "order": 2,
      "description": "Delete transient data, wizard records, and __export__ xmlids",
      "parallel": false,
      "critical": true
    },
    "id_shift": {
      "order": 3,
      "description": "Temporarily shift IDs to avoid conflicts during renumbering",
      "parallel": false,
      "critical": true
    },
    "id_compact": {
      "order": 4,
      "description": "Final sequential ID renumbering with preserved ordering",
      "parallel": false,
      "critical": true
    },
    "patch_jsonb": {
      "order": 5,
      "description": "Update JSONB fields containing old ID references",
      "parallel": true,
      "critical": false
    },
    "xmlid_rebuild": {
      "order": 6,
      "description": "Recreate ir_model_data external identifiers",
      "parallel": false,
      "critical": true
    },
    "sequence_sync": {
      "order": 7,
      "description": "Synchronize PostgreSQL sequences with MAX(id)",
      "parallel": true,
      "critical": true
    },
    "recompute": {
      "order": 8,
      "description": "Recompute stored computed fields if needed",
      "parallel": true,
      "critical": false
    }
  },
  "execution_order": [
    "res.company",
    "res.partner.category",
    "res.partner",
    "uom.uom",
    "product.template",
    "product.product",
    "pos.category",
    "account.account",
    "account.tax.group",
    "account.tax",
    "account.payment.term",
    "account.journal",
    "account.bank.statement",
    "account.bank.statement.line",
    "account.move",
    "account.move.line",
    "account.asset",
    "account.analytic.distribution.model",
    "crm.team",
    "hr.employee",
    "fleet.vehicle",
    "stock.location",
    "stock.warehouse",
    "stock.picking.type",
    "stock.rule",
    "stock.lot",
    "stock.quant",
    "mrp.bom",
    "mrp.bom.line",
    "sale.order",
    "project.project",
    "consolidation"
  ],
  "global_settings": {
    "batch_size": 1000,
    "enable_logging": true,
    "dry_run": false,
    "backup_before_execution": true,
    "skip_validation": false,
    "preserve_audit_trail": true,
    "xmlid_module": "marin_data",
    "xmlid_noupdate": true
  },
  "models": {
    "res.company": {
      "enabled": true,
      "table": "res_company",
      "description": "Companies - consolidation only (8→7)",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "account_account_res_company_rel",
              "column": "res_company_id",
              "action": "CASCADE"
            },
            {
              "table": "account_analytic_distribution_model",
              "column": "company_id",
              "action": "CASCADE"
            },
            {
              "table": "ir_default",
              "column": "company_id",
              "action": "CASCADE"
            },
            {
              "table": "onboarding_progress",
              "column": "company_id",
              "action": "CASCADE"
            },
            {
              "table": "payslip_tags_table",
              "column": "res_company_id",
              "action": "CASCADE"
            },
            {
              "table": "res_company_users_rel",
              "column": "cid",
              "action": "CASCADE"
            }
          ]
        },
        "id_compact": {
          "enabled": true,
          "strategy": "consolidation",
          "mapping": {
            "8": "7"
          },
          "description": "Merge duplicate company records"
        },
        "sequence_sync": {
          "enabled": true,
          "sequence": "res_company_id_seq"
        }
      }
    },
    "res.partner.category": {
      "enabled": true,
      "table": "res_partner_category",
      "description": "Partner categories with CASCADE self-reference",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "res_partner_category",
              "column": "parent_id",
              "action": "CASCADE"
            },
            {
              "table": "res_partner_res_partner_category_rel",
              "column": "category_id",
              "action": "CASCADE"
            }
          ]
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin",
          "condition": "id >= 1"
        }
      }
    },
    "res.partner": {
      "enabled": true,
      "table": "res_partner",
      "description": "Partners - renumber from 8590",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "account_reconcile_model_res_partner_rel",
              "column": "res_partner_id",
              "action": "CASCADE"
            },
            {
              "table": "account_reconcile_model_partner_mapping",
              "column": "partner_id",
              "action": "CASCADE"
            },
            {
              "table": "calendar_event_res_partner_rel",
              "column": "res_partner_id",
              "action": "CASCADE"
            },
            {
              "table": "discuss_channel_member",
              "column": "partner_id",
              "action": "CASCADE"
            },
            {
              "table": "documents_access",
              "column": "partner_id",
              "action": "CASCADE"
            },
            {
              "table": "knowledge_article_member",
              "column": "partner_id",
              "action": "CASCADE"
            },
            {
              "table": "mail_followers",
              "column": "partner_id",
              "action": "CASCADE"
            },
            {
              "table": "mail_mail_res_partner_rel",
              "column": "res_partner_id",
              "action": "CASCADE"
            },
            {
              "table": "mail_message_res_partner_rel",
              "column": "res_partner_id",
              "action": "CASCADE"
            },
            {
              "table": "mail_notification",
              "column": "res_partner_id",
              "action": "CASCADE"
            },
            {
              "table": "product_supplierinfo",
              "column": "partner_id",
              "action": "CASCADE"
            },
            {
              "table": "res_partner_bank",
              "column": "partner_id",
              "action": "CASCADE"
            },
            {
              "table": "res_partner_res_partner_category_rel",
              "column": "partner_id",
              "action": "CASCADE"
            },
            {
              "table": "slide_slide_partner",
              "column": "partner_id",
              "action": "CASCADE"
            }
          ]
        },
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM account_move_send_wizard_res_partner_rel",
            "DELETE FROM account_payment_register",
            "DELETE FROM authorize_debt_wizard",
            "DELETE FROM base_partner_merge_automatic_wizard",
            "DELETE FROM mail_compose_message",
            "DELETE FROM mail_message_reaction",
            "DELETE FROM mail_message_res_partner_starred_rel",
            "DELETE FROM mail_push_device",
            "DELETE FROM res_users_settings_volumes",
            "DELETE FROM slide_channel_partner",
            "DELETE FROM website_visitor",
            "DELETE FROM ir_model_data WHERE module='__export__' AND model='res.partner'",
            "DELETE FROM ir_model_data WHERE module='marin' AND model='res.partner' AND res_id>=5000",
            "DELETE FROM ir_model_data WHERE module='marin_data' AND model='res.partner' AND res_id>=5000"
          ]
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 8590,
          "order_by": "id",
          "condition": "id >= 8590"
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin_data",
          "condition": "active IN (true, false) AND id >= 5000",
          "name_pattern": "partner_{id}"
        },
        "sequence_sync": {
          "enabled": true,
          "sequence": "res_partner_id_seq"
        }
      }
    },
    "uom.uom": {
      "enabled": true,
      "table": "uom_uom",
      "description": "Units of measure - custom UOMs from 101",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "account_analytic_line",
              "column": "product_uom_id",
              "action": "SET NULL"
            },
            {
              "table": "account_move_line",
              "column": "product_uom_id",
              "action": "RESTRICT"
            },
            {
              "table": "product_template",
              "column": "uom_id",
              "action": "RESTRICT"
            },
            {
              "table": "mrp_bom_line",
              "column": "product_uom_id",
              "action": "RESTRICT"
            }
          ]
        },
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM ir_model_data WHERE module='__export__' AND model='uom.uom'",
            "DELETE FROM ir_model_data WHERE module='marin' AND model='uom.uom' AND res_id>=100"
          ]
        },
        "id_shift": {
          "enabled": true,
          "offset": 1000,
          "condition": "id >= 100"
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 101,
          "order_by": "relative_uom_id NULLS FIRST, relative_factor, name->>'en_US'",
          "condition": "id >= 100"
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin_data",
          "condition": "active IN (true, false) AND id >= 100",
          "name_pattern": "uom_{id}"
        }
      }
    },
    "product.template": {
      "enabled": true,
      "table": "product_template",
      "description": "Product templates - renumber from 2453",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "mrp_bom",
              "column": "product_tmpl_id",
              "action": "SET NULL"
            },
            {
              "table": "pos_category_product_template_rel",
              "column": "product_template_id",
              "action": "CASCADE"
            },
            {
              "table": "product_alternative_rel",
              "column": "src_id",
              "action": "CASCADE"
            },
            {
              "table": "product_alternative_rel",
              "column": "dest_id",
              "action": "CASCADE"
            },
            {
              "table": "product_product",
              "column": "product_tmpl_id",
              "action": "CASCADE"
            },
            {
              "table": "product_supplierinfo",
              "column": "product_tmpl_id",
              "action": "CASCADE"
            },
            {
              "table": "product_tag_product_template_rel",
              "column": "product_template_id",
              "action": "CASCADE"
            }
          ]
        },
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM website_track",
            "DELETE FROM stock_valuation_layer",
            "DELETE FROM stock_return_picking_line",
            "DELETE FROM ir_model_data WHERE module='__export__' AND model='product.template'",
            "DELETE FROM ir_model_data WHERE module='marin' AND model='product.template' AND res_id>1000",
            "DELETE FROM ir_model_data WHERE module='marin_data' AND model='product.template' AND res_id>1000"
          ]
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 2453,
          "order_by": "id",
          "condition": "id >= 2453"
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin_data",
          "condition": "active IN (true, false) AND id >= 1000",
          "name_pattern": "product_template_{id}"
        },
        "sequence_sync": {
          "enabled": true,
          "sequence": "product_template_id_seq"
        }
      }
    },
    "product.product": {
      "enabled": true,
      "table": "product_product",
      "description": "Product variants - sync IDs with template",
      "operations": {
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM ir_model_data WHERE module='__export__' AND model='product.product'",
            "DELETE FROM ir_model_data WHERE module='marin' AND model='product.product' AND res_id>1000",
            "DELETE FROM ir_model_data WHERE module='marin_data' AND model='product.product' AND res_id>1000"
          ]
        },
        "id_compact": {
          "enabled": true,
          "strategy": "custom",
          "start_id": 2453,
          "order_by": "id",
          "condition": "id >= 2453",
          "description": "Set product.product.id = product_tmpl_id for single-variant products"
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin_data",
          "condition": "active IN (true, false) AND id >= 1000",
          "name_pattern": "product_product_{id}"
        },
        "sequence_sync": {
          "enabled": true,
          "sequence": "product_product_id_seq"
        }
      }
    },
    "pos.category": {
      "enabled": true,
      "table": "pos_category",
      "description": "POS categories - shift by +99, start at 100",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "pos_category_product_template_rel",
              "column": "pos_category_id",
              "action": "CASCADE"
            },
            {
              "table": "pos_category_pos_config_rel",
              "column": "pos_category_id",
              "action": "CASCADE"
            }
          ]
        },
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM ir_model_data WHERE module='__export__' AND model='pos.category'",
            "DELETE FROM ir_model_data WHERE model='pos.category' AND res_id>1",
            "DELETE FROM ir_model_data WHERE module='marin' AND model='pos.category'"
          ]
        },
        "id_shift": {
          "enabled": true,
          "offset": 99,
          "condition": "id > 1"
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin",
          "condition": "id >= 100",
          "name_pattern": "pos_category_{id}"
        },
        "sequence_sync": {
          "enabled": true,
          "sequence": "pos_category_id_seq"
        }
      }
    },
    "account.account": {
      "enabled": true,
      "table": "account_account",
      "description": "Chart of accounts - preserve ordering",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "account_account_account_asset_rel",
              "column": "account_account_id",
              "action": "CASCADE"
            },
            {
              "table": "account_account_account_journal_rel",
              "column": "account_account_id",
              "action": "CASCADE"
            },
            {
              "table": "account_account_account_tag",
              "column": "account_account_id",
              "action": "CASCADE"
            },
            {
              "table": "account_account_res_company_rel",
              "column": "account_account_id",
              "action": "CASCADE"
            },
            {
              "table": "account_reconcile_model_line",
              "column": "account_id",
              "action": "CASCADE"
            }
          ]
        },
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM account_merge_wizard",
            "DELETE FROM ir_model_data WHERE module='__export__' AND model='account.account'",
            "DELETE FROM ir_model_data WHERE model='account.account' AND res_id>1000",
            "DELETE FROM ir_model_data WHERE module='marin_data' AND model='account.account'"
          ]
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin_data",
          "condition": "id > 1000",
          "name_pattern": "account_{code_store}_{company_code}",
          "description": "Use code_store for consistent naming"
        }
      }
    },
    "account.tax.group": {
      "enabled": true,
      "table": "account_tax_group",
      "description": "Tax groups - renumber from 1096",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "account_tax",
              "column": "tax_group_id",
              "action": "RESTRICT"
            },
            {
              "table": "account_move_line",
              "column": "tax_group_id",
              "action": "SET NULL"
            }
          ]
        },
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM ir_model_data WHERE module='__export__'",
            "DELETE FROM ir_model_data WHERE module='marin' AND model='account.tax.group'"
          ]
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 1096,
          "order_by": "company_id, name->>'en_US'",
          "condition": "id >= 1096"
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin",
          "condition": "id > 1000",
          "name_pattern": "tax_group_{id}_{name_slug}_{company_code}"
        }
      }
    },
    "account.tax": {
      "enabled": true,
      "table": "account_tax",
      "description": "Taxes with CASCADE to repartition lines",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "account_tax_repartition_line",
              "column": "tax_id",
              "action": "CASCADE"
            },
            {
              "table": "account_tax_purchase_order_line_rel",
              "column": "account_tax_id",
              "action": "CASCADE"
            },
            {
              "table": "account_tax_sale_order_line_rel",
              "column": "account_tax_id",
              "action": "CASCADE"
            },
            {
              "table": "account_move_line_account_tax_rel",
              "column": "account_tax_id",
              "action": "CASCADE"
            },
            {
              "table": "product_taxes_rel",
              "column": "tax_id",
              "action": "CASCADE"
            },
            {
              "table": "product_supplier_taxes_rel",
              "column": "tax_id",
              "action": "CASCADE"
            }
          ]
        }
      }
    },
    "account.payment.term": {
      "enabled": true,
      "table": "account_payment_term",
      "description": "Payment terms - renumber from 154",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "account_move",
              "column": "invoice_payment_term_id",
              "action": "SET NULL"
            },
            {
              "table": "account_payment_term_line",
              "column": "payment_id",
              "action": "CASCADE"
            }
          ]
        },
        "id_shift": {
          "enabled": true,
          "offset": 100000,
          "condition": "id > 153"
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 154,
          "order_by": "id",
          "condition": "id > 100000"
        }
      }
    },
    "account.journal": {
      "enabled": true,
      "table": "account_journal",
      "description": "Accounting journals",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": []
        }
      }
    },
    "account.bank.statement": {
      "enabled": true,
      "table": "account_bank_statement",
      "description": "Bank statements - renumber from 1",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "account_bank_statement_line",
              "column": "statement_id",
              "action": "SET NULL"
            },
            {
              "table": "account_move_line",
              "column": "statement_id",
              "action": "SET NULL"
            }
          ]
        },
        "id_shift": {
          "enabled": true,
          "offset": 1000000,
          "condition": "id >= 1"
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 1,
          "order_by": "name, company_id, journal_id",
          "condition": "id >= 1000000"
        }
      }
    },
    "account.bank.statement.line": {
      "enabled": true,
      "table": "account_bank_statement_line",
      "description": "Bank statement lines",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": []
        }
      }
    },
    "account.move": {
      "enabled": true,
      "table": "account_move",
      "description": "Journal entries - renumber from 1001",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "account_bank_statement_line",
              "column": "move_id",
              "action": "CASCADE"
            },
            {
              "table": "account_move_line",
              "column": "move_id",
              "action": "CASCADE"
            },
            {
              "table": "account_move_purchase_order_rel",
              "column": "account_move_id",
              "action": "CASCADE"
            },
            {
              "table": "account_move__account_payment",
              "column": "invoice_id",
              "action": "CASCADE"
            },
            {
              "table": "l10n_mx_edi_invoice_document_ids_rel",
              "column": "invoice_id",
              "action": "CASCADE"
            }
          ]
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 1001,
          "order_by": "date, company_id, journal_type_order, journal_code_order, commercial_partner_id, payment_reference, id",
          "description": "Complex ordering: date → company → journal type → journal code → partner → ref → id"
        }
      }
    },
    "account.move.line": {
      "enabled": true,
      "table": "account_move_line",
      "description": "Journal entry lines - renumber from 1001",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "account_partial_reconcile",
              "column": "credit_move_id",
              "action": "RESTRICT"
            },
            {
              "table": "account_partial_reconcile",
              "column": "debit_move_id",
              "action": "RESTRICT"
            },
            {
              "table": "account_move_line_account_tax_rel",
              "column": "account_move_line_id",
              "action": "CASCADE"
            },
            {
              "table": "asset_move_line_rel",
              "column": "line_id",
              "action": "CASCADE"
            },
            {
              "table": "account_account_tag_account_move_line_rel",
              "column": "account_move_line_id",
              "action": "CASCADE"
            },
            {
              "table": "account_analytic_line",
              "column": "move_line_id",
              "action": "CASCADE"
            }
          ]
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 1001,
          "order_by": "move_id, ARRAY_POSITION(ARRAY['product', 'tax', 'payment_term', 'line_note'], display_type), sequence, id",
          "description": "Order by move, then display_type, then sequence"
        }
      }
    },
    "account.asset": {
      "enabled": true,
      "table": "account_asset",
      "description": "Fixed assets",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": []
        }
      }
    },
    "account.analytic.distribution.model": {
      "enabled": true,
      "table": "account_analytic_distribution_model",
      "description": "Analytic distribution models - renumber from 1001",
      "operations": {
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM ir_model_data WHERE module='__export__' AND model='account.analytic.distribution.model'",
            "DELETE FROM ir_model_data WHERE module='marin' AND model='account.analytic.distribution.model'"
          ]
        },
        "id_shift": {
          "enabled": true,
          "offset": 10000,
          "condition": "id >= 1"
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 1001,
          "order_by": "company_id, product_id, vehicle_id, account_prefix"
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin",
          "name_pattern": "analytic_distribution_model_{id}"
        }
      }
    },
    "crm.team": {
      "enabled": true,
      "table": "crm_team",
      "description": "Sales teams",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": []
        }
      }
    },
    "hr.employee": {
      "enabled": true,
      "table": "hr_employee",
      "description": "Employees",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": []
        }
      }
    },
    "fleet.vehicle": {
      "enabled": true,
      "table": "fleet_vehicle",
      "description": "Fleet vehicles",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": []
        }
      }
    },
    "stock.location": {
      "enabled": true,
      "table": "stock_location",
      "description": "Stock locations - renumber from 5613",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "stock_location",
              "column": "location_id",
              "action": "CASCADE"
            },
            {
              "table": "stock_move",
              "column": "location_dest_id",
              "action": "RESTRICT"
            },
            {
              "table": "stock_move",
              "column": "location_id",
              "action": "RESTRICT"
            },
            {
              "table": "stock_move_line",
              "column": "location_dest_id",
              "action": "RESTRICT"
            },
            {
              "table": "stock_move_line",
              "column": "location_id",
              "action": "RESTRICT"
            },
            {
              "table": "stock_picking",
              "column": "location_dest_id",
              "action": "RESTRICT"
            },
            {
              "table": "stock_picking",
              "column": "location_id",
              "action": "RESTRICT"
            },
            {
              "table": "stock_quant",
              "column": "location_id",
              "action": "RESTRICT"
            },
            {
              "table": "stock_warehouse",
              "column": "lot_stock_id",
              "action": "RESTRICT"
            },
            {
              "table": "stock_warehouse",
              "column": "view_location_id",
              "action": "RESTRICT"
            },
            {
              "table": "stock_warehouse_orderpoint",
              "column": "location_id",
              "action": "CASCADE"
            }
          ]
        },
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM ir_model_data WHERE module='__export__' AND model='stock.location'",
            "DELETE FROM ir_model_data WHERE module='marin' AND model='stock.location'"
          ]
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 5613,
          "order_by": "id",
          "condition": "id >= 5613"
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin",
          "condition": "active IN (true, false) AND id >= 1",
          "name_pattern": "stock_location_{id}"
        },
        "sequence_sync": {
          "enabled": true,
          "sequence": "stock_location_id_seq"
        }
      }
    },
    "stock.warehouse": {
      "enabled": true,
      "table": "stock_warehouse",
      "description": "Warehouses - renumber from 7",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "stock_picking_type",
              "column": "warehouse_id",
              "action": "CASCADE"
            },
            {
              "table": "stock_route_warehouse",
              "column": "warehouse_id",
              "action": "CASCADE"
            },
            {
              "table": "stock_warehouse_orderpoint",
              "column": "warehouse_id",
              "action": "CASCADE"
            }
          ]
        },
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM ir_model_data WHERE module='marin' AND model='stock.warehouse'",
            "DELETE FROM ir_model_data WHERE module='__export__' AND model='stock.warehouse'"
          ]
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 7,
          "order_by": "id",
          "condition": "id >= 7 AND id <= 8"
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin",
          "condition": "active IN (true, false)",
          "name_pattern": "warehouse_{id}"
        }
      }
    },
    "stock.picking.type": {
      "enabled": true,
      "table": "stock_picking_type",
      "description": "Picking types (operations)",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": []
        }
      }
    },
    "stock.rule": {
      "enabled": true,
      "table": "stock_rule",
      "description": "Push/pull rules",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": []
        }
      }
    },
    "stock.lot": {
      "enabled": true,
      "table": "stock_lot",
      "description": "Serial/lot numbers",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": []
        }
      }
    },
    "stock.quant": {
      "enabled": true,
      "table": "stock_quant",
      "description": "Stock quants (inventory records)",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": []
        }
      }
    },
    "mrp.bom": {
      "enabled": true,
      "table": "mrp_bom",
      "description": "Bills of materials - renumber from 1001",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "mrp_bom_line",
              "column": "bom_id",
              "action": "CASCADE"
            }
          ]
        },
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM ir_model_data WHERE module='__export__' AND model='mrp.bom'",
            "DELETE FROM ir_model_data WHERE module='marin' AND model='mrp.bom'"
          ]
        },
        "id_shift": {
          "enabled": true,
          "offset": 10000,
          "condition": "id >= 1000"
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 1001,
          "order_by": "company_id, product_tmpl_id, code",
          "condition": "id >= 1000"
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin",
          "condition": "id > 1000",
          "name_pattern": "mrp_bom_{id}"
        }
      }
    },
    "mrp.bom.line": {
      "enabled": true,
      "table": "mrp_bom_line",
      "description": "BOM lines - renumber from 1001",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "stock_move",
              "column": "bom_line_id",
              "action": "SET NULL"
            }
          ]
        },
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM ir_model_data WHERE module='__export__' AND model='mrp.bom.line'",
            "DELETE FROM ir_model_data WHERE module='marin' AND model='mrp.bom.line'"
          ]
        },
        "id_shift": {
          "enabled": true,
          "offset": 10000,
          "condition": "id >= 1000"
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 1001,
          "order_by": "bom_id, sequence, id",
          "condition": "id >= 1000"
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin",
          "condition": "id > 1000",
          "name_pattern": "mrp_bom_line_{id}"
        }
      }
    },
    "sale.order": {
      "enabled": true,
      "table": "sale_order",
      "description": "Sales orders",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": []
        }
      }
    },
    "project.project": {
      "enabled": true,
      "table": "project_project",
      "description": "Projects - renumber from 14",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "project_task",
              "column": "project_id",
              "action": "SET NULL"
            },
            {
              "table": "project_task_type_rel",
              "column": "project_id",
              "action": "CASCADE"
            },
            {
              "table": "project_favorite_user_rel",
              "column": "project_id",
              "action": "CASCADE"
            },
            {
              "table": "project_milestone",
              "column": "project_id",
              "action": "CASCADE"
            },
            {
              "table": "project_project_project_tags_rel",
              "column": "project_project_id",
              "action": "CASCADE"
            }
          ]
        },
        "cleanup": {
          "enabled": true,
          "operations": [
            "DELETE FROM project_update",
            "DELETE FROM ir_model_data WHERE model='project.project'"
          ]
        },
        "id_compact": {
          "enabled": true,
          "strategy": "sequential",
          "start_id": 14,
          "order_by": "id",
          "condition": "id >= 14"
        },
        "xmlid_rebuild": {
          "enabled": true,
          "module": "marin",
          "condition": "active IN (true, false) AND id >= 1",
          "name_pattern": "project_{id}"
        },
        "sequence_sync": {
          "enabled": true,
          "sequence": "project_project_id_seq"
        }
      }
    },
    "consolidation": {
      "enabled": true,
      "table": "consolidation_chart",
      "description": "Consolidation module CASCADE constraints",
      "operations": {
        "fk_rewrite": {
          "enabled": true,
          "constraints": [
            {
              "table": "account_account_consolidation_account_rel",
              "column": "consolidation_account_id",
              "action": "CASCADE"
            },
            {
              "table": "consolidation_account",
              "column": "chart_id",
              "action": "CASCADE"
            },
            {
              "table": "consolidation_chart_res_company_rel",
              "column": "consolidation_chart_id",
              "action": "CASCADE"
            },
            {
              "table": "consolidation_company_period",
              "column": "period_id",
              "action": "CASCADE"
            },
            {
              "table": "consolidation_group",
              "column": "chart_id",
              "action": "CASCADE"
            },
            {
              "table": "consolidation_journal",
              "column": "chart_id",
              "action": "CASCADE"
            },
            {
              "table": "consolidation_journal",
              "column": "period_id",
              "action": "CASCADE"
            },
            {
              "table": "consolidation_period",
              "column": "chart_id",
              "action": "CASCADE"
            }
          ]
        }
      }
    }
  },
  "idempotency": {
    "enabled": true,
    "description": "Rules to ensure migrations can be re-run safely",
    "rules": [
      {
        "rule": "Check if migration already applied",
        "implementation": "Query ir_config_parameter for migration version"
      },
      {
        "rule": "Skip ID shifts if already shifted",
        "implementation": "Check if max(id) > shift_threshold"
      },
      {
        "rule": "Skip xmlid rebuild if already exists",
        "implementation": "Check ir_model_data existence before create"
      },
      {
        "rule": "Validate sequence sync",
        "implementation": "Ensure setval matches MAX(id)+1"
      }
    ]
  },
  "validation": {
    "pre_migration": [
      {
        "check": "Database backup exists",
        "critical": true
      },
      {
        "check": "No active users connected",
        "critical": true
      },
      {
        "check": "Sufficient disk space (>20% free)",
        "critical": true
      },
      {
        "check": "PostgreSQL version >= 12",
        "critical": true
      },
      {
        "check": "No pending cron jobs",
        "critical": false
      }
    ],
    "post_migration": [
      {
        "check": "All sequences synchronized",
        "critical": true
      },
      {
        "check": "No orphaned records",
        "critical": true
      },
      {
        "check": "XMLID coverage > 95%",
        "critical": false
      },
      {
        "check": "No ID gaps > 1000",
        "critical": false
      },
      {
        "check": "Database integrity (VACUUM ANALYZE)",
        "critical": true
      }
    ]
  },
  "special_operations": {
    "cash_basis_partner_fix": {
      "enabled": true,
      "description": "Set partner_id on cash basis move lines from tax_cash_basis_origin_move_id",
      "phase": "patch_jsonb",
      "sql": "UPDATE account_move_line SET partner_id = origin.partner_id FROM account_move_line origin INNER JOIN account_move move ON move.id = account_move_line.move_id WHERE move.tax_cash_basis_origin_move_id = origin.move_id AND account_move_line.partner_id IS NULL"
    },
    "jsonb_field_updates": {
      "enabled": true,
      "description": "Update JSONB fields containing old ID references",
      "phase": "patch_jsonb",
      "fields": [
        {
          "model": "account.move.line",
          "column": "analytic_distribution",
          "type": "jsonb",
          "update_strategy": "map_keys"
        },
        {
          "model": "account.analytic.distribution.model",
          "column": "analytic_distribution",
          "type": "jsonb",
          "update_strategy": "map_keys"
        }
      ]
    },
    "computed_field_recompute": {
      "enabled": false,
      "description": "Recompute stored fields after ID changes (usually not needed)",
      "phase": "recompute",
      "models": []
    }
  },
  "notes": {
    "critical_warnings": [
      "ALWAYS backup database before running migration",
      "Test in staging environment first",
      "Migration requires exclusive database access",
      "Estimated downtime: 30-45 minutes for production database"
    ],
    "execution_tips": [
      "Run during maintenance window",
      "Monitor disk space during execution",
      "Keep transaction logs for rollback capability",
      "Use --dry-run flag first to validate"
    ],
    "known_issues": [
      "Very large account.move.line tables (>10M rows) may require chunked processing",
      "JSONB field updates may be slow on large datasets",
      "Sequence sync must run with exclusive table lock"
    ],
    "version_history": [
      "v4.0 (2025-10-09): Phase-based architecture, comprehensive CASCADE rules, idempotency support",
      "v3.3: Previous version with flat operation structure",
      "v3.2: Initial multi-model support"
    ]
  }
}
